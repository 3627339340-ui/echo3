<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœªæ¥å›éŸ³ ğŸ’Œ</title>
<style>
  :root{
    --glass-bg: rgba(255,255,255,0.32);
    --glass-hover: rgba(255,255,255,0.54);
    --accent: #ff8fb3;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"PingFang SC","SF Pro Display",sans-serif;-webkit-font-smoothing:antialiased}
  body{
    display:flex;align-items:center;justify-content:center;flex-direction:column;
    background: radial-gradient(circle at center, #fff0f3 60%, #ffb7d1 85%, #b44b6a 100%);
    transition:background 900ms ease;
    color:#222;
    overflow:hidden;
  }

  /* ä¿¡å°å¼€åœº */
  .envelope-wrap{position:relative;z-index:3}
  .envelope{
    width:240px;height:160px;border-radius:12px;background:#fff;border:2px solid rgba(255,255,255,0.9);
    box-shadow:0 14px 40px rgba(180,60,100,0.18);
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    transform-origin:center; animation:envelope-sway 1.8s ease-in-out infinite alternate;
  }
  .envelope::before{
    content:"";position:absolute;left:0;right:0;margin:auto;top:-120px;border-left:120px solid transparent;border-right:120px solid transparent;border-bottom:70px solid #fff;border-radius:4px;
  }
  @keyframes envelope-sway{0%{transform:rotate(0deg)}50%{transform:rotate(2deg)}100%{transform:rotate(-2deg)}}
  .envelope.fade{opacity:0;transform:scale(.9);transition:all 700ms ease}

  /* ä¸»åŒºåŸŸï¼ˆæ ‡é¢˜ã€è¾“å…¥ã€ä¿¡çº¸ï¼‰ */
  .main{display:none;flex-direction:column;align-items:center;z-index:2;width:92%;max-width:720px;margin-top:2vh}
  h1{margin:0;margin-top:6vh;font-size:3rem;color:#fff;letter-spacing:2px;text-align:center;text-shadow:0 6px 22px rgba(255,150,170,0.25)}
  .panel{
    margin-top:28px;width:100%;background:var(--glass-bg);backdrop-filter:blur(12px);border-radius:20px;padding:24px;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
  }

  textarea{
    width:100%;min-height:150px;border-radius:12px;border:none;padding:16px;font-size:16px;resize:vertical;background:rgba(255,255,255,0.72);outline:none;color:#222;
  }

  .controls{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:14px}
  .btn{
    border:none;padding:10px 18px;border-radius:999px;background:var(--glass-bg);backdrop-filter:blur(10px);cursor:pointer;color:#fff;font-weight:600;
    transition:background .2s, transform .12s;
  }
  .btn:hover{background:var(--glass-hover)}
  .btn:active{transform:translateY(1px)}

  /* ä¿¡çº¸åŒºåŸŸ */
  .letter{
    display:none;margin-top:20px;width:100%;max-height:420px;overflow:auto;background:rgba(255,255,255,0.92);padding:22px;border-radius:16px;color:#222;box-shadow:0 10px 30px rgba(0,0,0,0.08);
  }
  .letter pre{white-space:pre-wrap;margin:0;font-size:16px;line-height:1.7}

  /* å°æŒ‰é’®æ ·å¼ç»Ÿä¸€ä¸ºç£¨ç ‚ç™½åŠé€æ˜ */
  .small{padding:8px 14px;border-radius:14px;font-size:15px}

  /* éŸ³é¢‘/æ’­æ”¾çŠ¶æ€è§†è§‰ */
  #playBtn.playing{background:linear-gradient(90deg,#ff99b7,#ffcbd6);color:#6b0036}

  /* å“åº” */
  @media (max-width:520px){
    h1{font-size:2rem}
    .envelope{width:180px;height:120px}
  }
</style>
</head>
<body>
  <!-- å¼€åœºä¿¡å° -->
  <div class="envelope-wrap">
    <div class="envelope" id="envelope">ğŸ’Œ</div>
  </div>

  <!-- ä¸»å†…å®¹ -->
  <div class="main" id="mainUI" role="main" aria-live="polite">
    <h1>æœªæ¥å›éŸ³ ğŸ’Œ</h1>

    <div class="panel" id="panel">
      <textarea id="userInput" placeholder="æŠŠä½ è¿™ä¸€åˆ»æƒ³å¯¹æœªæ¥çš„è‡ªå·±è¯´çš„è¯å†™ä¸‹æ¥..."></textarea>

      <div class="controls" style="justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn small" id="bgHint" title="ç‚¹å‡»èƒŒæ™¯ç©ºç™½å¤„å¯åˆ‡æ¢èƒŒæ™¯ï¼ˆä¸ä¼šåœ¨è¾“å…¥/å›ä¿¡åŒºè§¦å‘ï¼‰">èƒŒæ™¯ï¼šç‚¹å‡»åŒºåŸŸå¤–åˆ‡æ¢</button>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn small" id="generateBtn">ç”Ÿæˆæœªæ¥å›ä¿¡</button>
        </div>
      </div>
    </div>

    <div class="letter" id="letterBox" aria-hidden="true">
      <pre id="replyText"></pre>
      <div class="controls" style="justify-content:flex-end;margin-top:16px">
        <button class="btn small" id="playBtn">æ’­æ”¾è¯­éŸ³</button>
        <button class="btn small" id="stopBtn" style="display:none">åœæ­¢æ’­æ”¾</button>
        <button class="btn small" id="closeBtn">æ”¶èµ·å›ä¿¡</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // elements
  const envelope = document.getElementById('envelope');
  const mainUI = document.getElementById('mainUI');
  const generateBtn = document.getElementById('generateBtn');
  const userInput = document.getElementById('userInput');
  const letterBox = document.getElementById('letterBox');
  const replyText = document.getElementById('replyText');
  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');
  const closeBtn = document.getElementById('closeBtn');
  const panel = document.getElementById('panel');

  let utter = null;
  let isPlaying = false;

  // open envelope either click or auto after 3s
  function openEnvelope() {
    if (envelope.dataset.opened) return;
    envelope.dataset.opened = '1';
    envelope.classList.add('fade');
    setTimeout(() => {
      envelope.style.display = 'none';
      mainUI.style.display = 'flex';
      // focus input
      setTimeout(()=>userInput.focus(), 200);
    }, 700);
  }
  envelope.addEventListener('click', openEnvelope);
  setTimeout(() => openEnvelope(), 3000);

  // helper: only change background when clicking outside input and letter
  function bodyClickHandler(e) {
    const target = e.target;
    if (panel.contains(target) || letterBox.contains(target) || envelope.contains(target)) {
      // inside input/letter/envelope => do nothing
      return;
    }
    // change to a softer warm gradient with gentle transition
    const choices = [
      'radial-gradient(circle at center, #fff6f8 60%, #ffc8db 90%, #bd4060 100%)',
      'radial-gradient(circle at center, #fff7ee 60%, #ffd2b2 90%, #c65b4a 100%)',
      'radial-gradient(circle at center, #fff0f5 60%, #ffbcd3 90%, #b64b70 100%)'
    ];
    const g = choices[Math.floor(Math.random()*choices.length)];
    document.body.style.background = g;
  }
  document.body.addEventListener('click', bodyClickHandler, false);

  // generate reply via backend
  generateBtn.addEventListener('click', async () => {
    const text = userInput.value.trim();
    if (!text) { alert('è¯·å…ˆå†™ä¸‹ä½ çš„å¿ƒå£° ğŸ˜Š'); userInput.focus(); return; }

    // hide any previous
    letterBox.style.display = 'none';
    replyText.textContent = 'æ­£åœ¨å‘æœªæ¥ç´¢å–å›ä¿¡ï¼Œè¯·ç¨å€™â€¦â€¦';

    // call server API
    try {
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: text })
      });
      const data = await res.json();
      const reply = (data && data.reply) ? data.reply : 'æœªæ¥çš„ä¿¡ä»¶æš‚æ—¶æ— æ³•é€è¾¾ï¼Œè¯·ç¨åå†è¯•ã€‚';
      // display as letter (preserve newlines)
      replyText.textContent = reply;
      letterBox.style.display = 'block';
      letterBox.setAttribute('aria-hidden','false');
      // scroll to top
      letterBox.scrollTop = 0;
      // auto focus: do not change background logic
      // ensure play/stop buttons initial state
      playBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      isPlaying = false;
      if (utter) { speechSynthesis.cancel(); utter = null; }
    } catch (err) {
      console.error(err);
      replyText.textContent = 'ç½‘ç»œæˆ–æœåŠ¡å¼‚å¸¸ï¼Œç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
      letterBox.style.display = 'block';
    }
  });

  // play / stop logic (button overlay behavior)
  playBtn.addEventListener('click', () => {
    const text = replyText.textContent.trim();
    if (!text) return;
    // create utterance
    utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'zh-CN';
    utter.rate = 1;
    utter.pitch = 1;
    // try to pick a suitable voice (prefer Chinese)
    const voices = speechSynthesis.getVoices();
    if (voices && voices.length) {
      const zh = voices.find(v => /zh|Chinese/i.test(v.lang) || /Chinese|å¥³|å¥³å£°|ç”·æ€§|male|female/i.test(v.name));
      if (zh) utter.voice = zh;
    }
    // switch UI
    isPlaying = true;
    playBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    // speak
    speechSynthesis.speak(utter);

    // on end or on error: restore
    const done = () => {
      isPlaying = false;
      playBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      utter = null;
    };
    utter.onend = done;
    utter.onerror = () => {
      console.error('speech error');
      done();
    };
  });

  // stop button directly stops and restores UI
  stopBtn.addEventListener('click', () => {
    if (utter) {
      speechSynthesis.cancel();
      // onend will trigger; but restore immediately
      isPlaying = false;
      playBtn.style.display = 'inline-block';
      stopBtn.style.display = 'none';
      utter = null;
    }
  });

  // ensure that if speechSynthesis ends unexpectedly, UI resets
  window.speechSynthesis.onend = () => {
    isPlaying = false;
    playBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    utter = null;
  };

  // close (æ”¶èµ·å›ä¿¡) => return to input area instantly
  closeBtn.addEventListener('click', () => {
    // stop any playing audio
    if (utter) { speechSynthesis.cancel(); utter = null; }
    letterBox.style.display = 'none';
    userInput.focus();
    // keep input area visible (it's always visible)
    // scroll to top of panel
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // prevent body click handler from firing while clicking inside input or letter: already checked in handler via contains()

  // ensure voices are loaded (some browsers load asynchronously)
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = () => { /* voices ready */ };
  }
})();
</script>
</body>
</html>
